# ç™½å…‰å¹²æ¶‰ (WSI) 3Dè¡¨é¢é‡å»ºä»¿çœŸå¹³å°
Simulation of White Light Interferometry (WSI) Signal Processing and Surface Reconstruction

[![Python 3.9+](https://img.shields.io/badge/python-3.9+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

## ğŸ“˜ é¡¹ç›®ç®€ä»‹ (Project Overview)

æœ¬é¡¹ç›®æ„å»ºäº†ä¸€ä¸ªç«¯åˆ°ç«¯çš„ç™½å…‰å¹²æ¶‰æµ‹é‡ï¼ˆWSIï¼‰ä¿¡å·ä»¿çœŸä¸å¤„ç†å¹³å°ã€‚å®ƒæ¨¡æ‹Ÿäº†çœŸå®æµ‹é‡è¿‡ç¨‹ä¸­çš„å¹²æ¶‰ä¿¡å·é‡‡é›†ã€æ³¨å…¥é«˜æŒ‘æˆ˜æ€§çš„ç”Ÿäº§ç¯å¢ƒå™ªå£°ï¼ˆå¦‚æœºæ¢°æŒ¯åŠ¨å’Œä¼ æ„Ÿå™¨å™ªå£°ï¼‰ï¼Œå¹¶ä½¿ç”¨å·¥ä¸šæ ‡å‡†çš„æ•°å€¼ç®—æ³•å®ç°è¡¨é¢å½¢è²Œçš„3Dé‡å»ºä¸æ€§èƒ½åˆ†æã€‚

## âœ³ï¸ æŠ€æœ¯èƒŒæ™¯ (Engineering Significance)

åœ¨é«˜ç«¯åˆ¶é€ é¢†åŸŸï¼Œç‰¹åˆ«æ˜¯åœ¨æ•°æ®å­˜å‚¨ï¼ˆå¦‚ï¼šç¡¬ç›˜ç›˜ç‰‡ã€è¯»å†™ç£å¤´ï¼‰å’ŒåŠå¯¼ä½“è¡Œä¸šä¸­ï¼Œå¯¹ç»„ä»¶è¿›è¡Œéæ¥è§¦ã€çº³ç±³çº§çš„è¡¨é¢å½¢è²Œæµ‹é‡è‡³å…³é‡è¦ã€‚WSIæ˜¯ç¡¬ç›˜ç£å¤´ï¼ˆABSï¼‰å’Œç›˜ç‰‡è¡¨é¢å½¢è²Œæ£€æµ‹çš„æ ¸å¿ƒæŠ€æœ¯ä¹‹ä¸€ï¼Œèƒ½å¤Ÿæµ‹é‡çº³ç±³çº§å°é˜¶é«˜åº¦ä¸è¡¨é¢ç²—ç³™åº¦ã€‚

æœ¬é¡¹ç›®æ ¸å¿ƒä»·å€¼åœ¨äºèåˆäº†å·¥ç¨‹å®ç°ä¸ç†è®ºåˆ†æï¼š

1.  **å·¥ç¨‹å®ç° (Python)**: å®ç°äº†ä»3DåŸå§‹æ•°æ®æ ˆ (z, y, x) åˆ°2Dè¡¨é¢å›¾ (y, x) çš„å®Œæ•´å·¥ä¸šå¤„ç†ç®¡çº¿ã€‚
2.  **é²æ£’æ€§åˆ†æ**: ä»¿çœŸä¸­æ³¨å…¥äº†å—æ§çš„éšæœºè¿‡ç¨‹ï¼ˆæ¨¡æ‹Ÿæœºæ¢°æŒ¯åŠ¨å’Œä¼ æ„Ÿå™¨å™ªå£°ï¼‰ï¼Œç”¨ä»¥é‡åŒ–åˆ†æä¸¤ç§ä¸»æµç®—æ³•ï¼ˆCPSå’ŒFFTï¼‰åœ¨å™ªå£°ä¸‹çš„é²æ£’æ€§ã€‚

è¯¥å¹³å°å±•ç¤ºäº†å°†å¤æ‚ç‰©ç†è®¡é‡è¿‡ç¨‹æŠ½è±¡ä¸ºæ•°å­¦æ¨¡å‹ï¼Œå¹¶ä¸ºå…¶å¼€å‘å’ŒéªŒè¯é²æ£’æ•°æ®åˆ†æç®—æ³•çš„èƒ½åŠ›ã€‚

---

## ğŸš€ ä¸»è¦åŠŸèƒ½

* **3Dè¡¨é¢ä»¿çœŸ**ï¼šç”Ÿæˆå¸¦æœ‰çº³ç±³çº§å°é˜¶ï¼ˆä¾‹å¦‚40nmï¼‰çš„æ¨¡æ‹Ÿè¡¨é¢ã€‚
* **WSIä¿¡å·æ ˆç”Ÿæˆ**ï¼šåŸºäºç‰©ç†å‚æ•°ï¼ˆä¸­å¿ƒæ³¢é•¿ã€ç›¸å¹²é•¿åº¦ï¼‰ä¸ºæ•´ä¸ªè¡¨é¢ç”Ÿæˆç†æƒ³çš„3Då¹²æ¶‰ä¿¡å·æ ˆ (z, y, x)ã€‚
* **é«˜ä¿çœŸå™ªå£°æ¨¡å‹**ï¼šæ³¨å…¥çœŸå®ä¸”å¯Œæœ‰æŒ‘æˆ˜æ€§çš„å™ªå£°ï¼ŒåŒ…æ‹¬ï¼š
    * ä¹˜æ€§çš„æŒ¯åŠ¨ç›¸ä½å™ªå£°ï¼ˆä¾‹å¦‚ 10nm @ 50Hzï¼‰ã€‚
    * åŠ æ€§é«˜æ–¯ç™½å™ªå£°ï¼ˆAWGNï¼‰ï¼ˆä¾‹å¦‚ 30dB SNRï¼‰ã€‚
* **ç®—æ³•é‡å»º**ï¼šåŒ…å«ä¸¤ç§å·²éªŒè¯çš„å·¥ä¸šçº§3Dé‡å»ºç®—æ³•ï¼š
    1.  **ç›¸å¹²å³°å€¼æœå¯» (CPS)**ï¼šä¸€ç§å¿«é€Ÿã€é²æ£’çš„æ—¶åŸŸç®—æ³•ã€‚
    2.  **FFTç›¸ä½ç®—æ³• (Takeda)**ï¼šä¸€ç§é«˜ç²¾åº¦çš„é¢‘åŸŸç®—æ³•ã€‚
* **å®šé‡åˆ†æ**ï¼š`main.py` è„šæœ¬æä¾›ä¸¤ç§ç®—æ³•çš„æ€§èƒ½å¯¹æ¯”ï¼Œè®¡ç®—é‡å»ºå°é˜¶é«˜åº¦ã€èƒŒæ™¯å™ªå£°å’Œå…¨å±€RMSEã€‚
* **äº¤äº’å¼æ¼”ç¤º**ï¼š`wsi_demo.ipynb` æä¾›äº†CPSç®—æ³•åœ¨é«˜å™ªå£°ä¸‹é‡å»ºè¿‡ç¨‹çš„å¯è§†åŒ–åˆ†æ­¥æŒ‡å—ã€‚

---

## ğŸ“‚ é¡¹ç›®ç»“æ„ä¸æ¨¡å—åŠŸèƒ½

è¿™æ˜¯æœ¬é¡¹ç›®çš„ç†æƒ³æ–‡ä»¶ç»“æ„ã€‚

```markdown
WSI_Simulation/
â”œâ”€â”€ .gitignore             # (æ¨èæ·»åŠ )
â”œâ”€â”€ main.py                # ä¸»è„šæœ¬ï¼šè¿è¡Œ3Dä»¿çœŸï¼Œå¯¹æ¯”CPSå’ŒFFTç®—æ³•
â”œâ”€â”€ notebooks/
â”‚   â””â”€â”€ wsi_demo.ipynb     # äº¤äº’å¼ç¬”è®°æœ¬ï¼šCPSç®—æ³•çš„åˆ†æ­¥æ¼”ç¤º
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ signal_generator.py # 1. ä¿¡å·ç”Ÿæˆ
â”‚   â”œâ”€â”€ noise_model.py     # 2. å™ªå£°æ³¨å…¥
â”‚   â”œâ”€â”€ processing.py      # 3. æ ¸å¿ƒå¤„ç†ç®—æ³• (CPS & FFT)
â”‚   â”œâ”€â”€ phase_unwrap.py    # 4. 2Dç›¸ä½è§£åŒ…è£¹ (FFTç®—æ³•ä½¿ç”¨)
â”‚   â”œâ”€â”€ visualization.py   # ç»˜å›¾å·¥å…·
â”‚   â””â”€â”€ utils.py           # è¾…åŠ©å·¥å…·
â”œâ”€â”€ data/
â”‚   â””â”€â”€ example_output/    # ä»¿çœŸç»“æœå›¾åƒçš„ä¿å­˜ä½ç½®
â””â”€â”€ README.md              # æœ¬æ–‡ä»¶
```

### âš™ï¸ ç®—æ³•åŸç†ä¸æ•°å­¦å…¬å¼
### A. ç™½å…‰å¹²æ¶‰ä¿¡å·æ¨¡å‹
WSIä¿¡å·æ ˆ stack[z, y, x] ä¸­æ¯ä¸ªåƒç´  (y, x) çš„å…‰å¼º $I$ éšæ‰«æä½ç½® $z$ çš„å˜åŒ–ï¼Œå¯ä»¥å»ºæ¨¡ä¸ºï¼š
$$I(z) = I_{dc} + \gamma(z-h) \cdot \cos\left(\frac{4\pi}{\lambda_c}(z-h)\right)$$
å…¶ä¸­ï¼š
- $h$ æ˜¯è¯¥åƒç´ å¯¹åº”çš„è¡¨é¢é«˜åº¦ã€‚
- $I_{dc}$ æ˜¯ç›´æµèƒŒæ™¯å…‰å¼ºã€‚
- $\gamma(z-h)$ æ˜¯é«˜æ–¯ç›¸å¹²åŒ…ç»œï¼ˆCoherence Envelopeï¼‰ï¼Œå…¶å³°å€¼ä½äº $z=h$ å¤„ã€‚
- $\lambda_c$ æ˜¯å…‰æºçš„ä¸­å¿ƒæ³¢é•¿ã€‚
- æˆ‘ä»¬çš„ç›®æ ‡æ˜¯ä»è¿™ä¸ª3Dä¿¡å·æ ˆä¸­ç²¾ç¡®æ±‚è§£å‡ºæ¯ä¸ªåƒç´ çš„ $h(y, x)$ã€‚

### B. ç®—æ³•ä¸€ï¼šç›¸å¹²å³°å€¼æœå¯» (CPS) - (åœ¨ wsi_demo.ipynb ä¸­ä½¿ç”¨)
è¿™æ˜¯ä¸€ç§åŸºäºæ—¶åŸŸçš„é²æ£’ç®—æ³•ï¼Œå®ƒä¸ä¾èµ–ç›¸ä½ï¼Œè€Œæ˜¯ç›´æ¥æµ‹é‡ç›¸å¹²åŒ…ç»œ $\gamma$ çš„å³°å€¼ä½ç½®ã€‚
- **è§£æä¿¡å·**: ä½¿ç”¨ scipy.signal.hilbert æ²¿Zè½´è®¡ç®—è§£æä¿¡å· $I_a(z) = I(z) + j \cdot \mathcal{H}\{I(z)\}$ã€‚
- **åŒ…ç»œæå–**: æå–ä¿¡å·åŒ…ç»œ $\gamma(z) = |I_a(z)|$ã€‚
- **å¼ºåŠ›å¹³æ»‘ (å…³é”®)**: ä½¿ç”¨é«˜æ–¯æ»¤æ³¢å™¨ (gaussian_filter1d) å¯¹åŒ…ç»œ $\gamma(z)$ è¿›è¡Œå¹³æ»‘ï¼ˆä¾‹å¦‚ sigma=8.0ï¼‰ï¼Œè¿™æ˜¯åœ¨é«˜å™ªå£°ä¸‹å‡†ç¡®å®šä½çš„æ ¸å¿ƒã€‚æ•´æ•°å³°å€¼å®šä½: æ‰¾åˆ°å¹³æ»‘ååŒ…ç»œçš„æ•´æ•°å³°å€¼ç´¢å¼• $z_m = \text{argmax}(\gamma_{smooth}(z))$ã€‚
- **äºšåƒç´ æ’å€¼**: åœ¨æ•´æ•°å³°å€¼ $z_m$ åŠå…¶ç›¸é‚»ç‚¹ ($z_{m-1}$, $z_{m+1}$) ä¸Šï¼Œä½¿ç”¨äºŒæ¬¡æ›²çº¿ï¼ˆæŠ›ç‰©çº¿ï¼‰æ‹Ÿåˆæ¥æ‰¾åˆ°äºšåƒç´ åç§»é‡ $\delta$ ã€‚
$$\delta = \frac{\gamma(z_{m-1}) - \gamma(z_{m+1})}{2 \cdot (\gamma(z_{m-1}) - 2\gamma(z_m) + \gamma(z_{m+1}))}$$
- **é«˜åº¦è½¬æ¢**: æœ€ç»ˆçš„é«˜åº¦ $h$ æ˜¯æ•´æ•°å³°å€¼ä½ç½®ä¸äºšåƒç´ åç§»é‡çš„çº¿æ€§æ’å€¼ç»“æœ $h = \text{interp}(z_m + \delta, z_{indices}, Z_{SCAN})$ã€‚
### C. ç®—æ³•äºŒï¼šFFTç›¸ä½æå– (Takeda) - (åœ¨ main.py ä¸­ä½¿ç”¨)
è¿™æ˜¯ä¸€ç§åŸºäºé¢‘åŸŸçš„é«˜ç²¾åº¦ç®—æ³•ï¼ˆåŸºäºTakedaçš„FTMæ–¹æ³• [1]ï¼‰ï¼Œå®ƒæµ‹é‡çš„æ˜¯è½½æ³¢é¢‘ç‡ $k_c$ å¤„çš„ç›¸ä½ã€‚
1.  **FFT (Zè½´)**: å¯¹ $I(z)$ æ‰§è¡Œä¸€ç»´FFTï¼Œå¾—åˆ°å…¶é¢‘è°± $I(k)$ã€‚
2.  **è½½æ³¢é¢‘ç‡å®šä½**: æ‰¾åˆ°æ­£é¢‘ç‡ $k>0$ é¢‘è°±ä¸­çš„å³°å€¼ $k_c$ å¯¹åº”çš„ç»å¯¹ç´¢å¼• `center_idx_absolute`ã€‚
3.  **ç›¸ä½æå–**: æå–è¯¥ç´¢å¼•å¤„æ‰€æœ‰åƒç´  (y, x) çš„ç›¸ä½è§’ $\phi_w(y, x)$ï¼Œè®¡ç®—æ–¹å¼ä¸º `np.angle(I_fft[center_idx_absolute, y, x])`ã€‚è¿™å°±æ˜¯2DåŒ…è£¹ç›¸ä½å›¾ã€‚
4.  **ç›¸å¹²åº¦æå–**: åŒæ—¶æå–è¯¥ç´¢å¼•å¤„çš„å¹…åº¦ $C(y, x)$ï¼Œè®¡ç®—æ–¹å¼ä¸º `np.abs(I_fft[center_idx_absolute, y, x])`ï¼Œä½œä¸ºç›¸å¹²åº¦å›¾ã€‚
5.  **2Dè§£åŒ…è£¹**: ï¼ˆ**å…³é”®æ­¥éª¤**ï¼‰ä½¿ç”¨ `skimage.restoration.unwrap_phase`ï¼ˆåŸºäºHerrÃ¡ezç­‰äººçš„å¯é æ€§æ’åºç®—æ³• [2]ï¼‰å¯¹ $\phi_w(y, x)$ è¿›è¡Œè§£åŒ…è£¹ï¼Œæ¢å¤è¿ç»­ç›¸ä½ $\phi(y, x)$ã€‚
6.  **é«˜åº¦è½¬æ¢**: å°†æœ€ç»ˆçš„è¿ç»­ç›¸ä½ $\phi$ è½¬æ¢ä¸ºé«˜åº¦ $h$ã€‚ç”±äºå…‰è·¯æ˜¯å¾€è¿”çš„ï¼ˆåå°„å¼ï¼‰ï¼Œå› æ­¤ä½¿ç”¨ $4\pi$ å› å­ï¼š
$$h = \frac{\lambda_c}{4\pi} \cdot \phi$$
*(æ³¨æ„: æ­¤æ–¹æ³•å¯èƒ½å­˜åœ¨ $\pi$ ç›¸ä½æ¨¡ç³Šæˆ–ç¬¦å·åè½¬ï¼ˆå¦‚ `reconstructed_surface_FFT.png` æ‰€ç¤ºçš„-40nmå°é˜¶ï¼‰ï¼Œè¿™åœ¨åŸºäºç›¸ä½çš„æµ‹é‡ä¸­æ˜¯æ­£å¸¸çš„ï¼Œå¯ä»¥é€šè¿‡åå¤„ç†æ ¡æ­£ç¬¦å·ã€‚)*

---
### ğŸš€ å¿«é€Ÿå¼€å§‹
1. ä¾èµ–å®‰è£…
æœ¬é¡¹ç›®ä¾èµ– Python 3.10 åŠä»¥ä¸‹ç§‘å­¦è®¡ç®—åº“ï¼š

- `numpy`

- `scipy`

- `matplotlib`

- `scikit-image`

- `jupyter` (ç”¨äºè¿è¡Œç¬”è®°æœ¬)

å»ºè®®åœ¨å…‹éš†ä»“åº“åï¼Œä½¿ç”¨pipå®‰è£…ï¼š

```Bash
git clone [https://github.com/Liz915/WSI_Simulation.git](https://github.com/Liz915/WSI_Simulation.git)
cd WSI_Simulation
pip install numpy scipy matplotlib scikit-image jupyter
```
### 2. é€‰é¡¹ Aï¼šäº¤äº’å¼æ¼”ç¤º (æ¨è)
`wsi_demo.ipynb` ç¬”è®°æœ¬ æä¾›äº†ä¸€ä¸ªåˆ†æ­¥çš„å¯è§†åŒ–æŒ‡å—ï¼Œé‡ç‚¹æ¼”ç¤ºäº†CPSç®—æ³•åœ¨10nmæŒ¯åŠ¨å’Œ30dBé«˜å™ªå£°ä¸‹çš„é‡å»ºè¿‡ç¨‹ã€‚

ä»é¡¹ç›®æ ¹ç›®å½•ï¼ˆå³ `main.py` æ‰€åœ¨çš„ç›®å½•ï¼‰å¯åŠ¨ Jupyterï¼š

```Bash
jupyter notebook
```
åœ¨Jupyteræ–‡ä»¶æµè§ˆå™¨ä¸­ï¼Œå¯¼èˆªåˆ° `notebooks/` æ–‡ä»¶å¤¹å¹¶æ‰“å¼€ `wsi_demo.ipynb`ã€‚

æŒ‰ç…§ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºè¿è¡Œæ‰€æœ‰å•å…ƒæ ¼ï¼ŒæŸ¥çœ‹ä»¿çœŸã€åŠ å™ªå’Œé‡å»ºçš„æ¯ä¸€æ­¥è¾“å‡ºã€‚

### 3. é€‰é¡¹ Bï¼šå®Œæ•´ä»¿çœŸä¸åˆ†æ (ä¸»è„šæœ¬)
`main.py` è„šæœ¬ è¿è¡Œä¸€ä¸ªå®Œæ•´çš„3Dä»¿çœŸï¼Œä½¿ç”¨CPSç®—æ³•å’ŒFFTç›¸ä½ç®—æ³•å¤„ç†ç›¸åŒçš„é«˜å™ªå£°æ•°æ®ï¼Œå¹¶æ‰“å°å®šé‡æ€§èƒ½å¯¹æ¯”ï¼ˆå°é˜¶é«˜åº¦, RMSE, å™ªå£°, é€Ÿåº¦ï¼‰ã€‚

ä»é¡¹ç›®æ ¹ç›®å½•è¿è¡Œï¼š

```Bash

python main.py
```
è„šæœ¬å°†åœ¨æ§åˆ¶å°æ‰“å°è¯¦ç»†çš„æ—¥å¿—å’Œæœ€ç»ˆçš„æ€§èƒ½å¯¹æ¯”æŠ¥å‘Šã€‚

### ğŸ“Š ç¤ºä¾‹è¾“å‡º (3Dä»¿çœŸç»“æœ)
è„šæœ¬è¿è¡Œåï¼Œ æ‰€æœ‰ç»“æœå›¾åƒå°†è‡ªåŠ¨ä¿å­˜åˆ° `data/example_output/` ç›®å½•ä¸­ã€‚

æ¥è‡ª `wsi_demo.ipynb` (CPS æ¼”ç¤º):
- `WSI_Final_Results_CPS_EN.png`: å››åˆä¸€åˆ†æå›¾ï¼ŒåŒ…å«çœŸå®è¡¨é¢ã€ä¸­å¿ƒå¹²æ¶‰å›¾ã€ç›¸å¹²å›¾å’Œæœ€ç»ˆé‡å»ºçš„3Dè¡¨é¢ã€‚

æ¥è‡ª `main.py` (ç®—æ³•å¯¹æ¯”):
- `main_interferogram_center_pixel.png`: ä¸­å¿ƒåƒç´ çš„ç†æƒ³ä¿¡å· vs. å™ªå£°ä¿¡å·ã€‚

- `reconstructed_surface_CPS.png`: CPSç®—æ³•é‡å»ºçš„3Dè¡¨é¢ï¼ˆæ˜¾ç¤º+40nmå°é˜¶ï¼‰ã€‚

- `reconstructed_surface_FFT.png`: FFTç®—æ³•é‡å»ºçš„3Dè¡¨é¢ï¼ˆæ˜¾ç¤º-40nmåç›¸å°é˜¶ï¼‰ã€‚

### ğŸ“š å‚è€ƒæ–‡çŒ®
[1] Takeda, M., Ina, H., & Kobayashi, S. (1982). Fourier-transform method of fringe-pattern analysis for computer-based topography and interferometry. Journal of the Optical Society of America, 72(1), 156-160. é“¾æ¥: https://opg.optica.org/josa/abstract.cfm?uri=josa-72-1-156

[2] HerrÃ¡ez, M. A., et al. (2002). Fast two-dimensional phase-unwrapping algorithm based on sorting by reliability following a noncontinuous path. Applied Optics, 41(35), 7437-7444. é“¾æ¥: https://opg.optica.org/ao/abstract.cfm?URI=ao-41-35-7437
